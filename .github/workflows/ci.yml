# MLRun CI Pipeline
# Runs on PRs and pushes to main
# See: docs/testing.md for test strategy

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ===========================================================================
  # Proto Validation
  # ===========================================================================

  proto:
    name: Proto Lint & Breaking Changes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # Fetch full history for breaking change detection
          fetch-depth: 0

      - name: Install buf
        uses: bufbuild/buf-setup-action@v1
        with:
          version: "1.47.2"

      - name: Lint protos
        run: buf lint

      - name: Check for breaking changes
        # Only check breaking changes on PRs, not main pushes
        if: github.event_name == 'pull_request'
        run: buf breaking --against '.git#branch=main'

  # ===========================================================================
  # Rust
  # ===========================================================================

  rust-lint:
    name: Rust Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.x"

      - name: Check formatting
        run: cargo fmt --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  rust-test:
    name: Rust Test
    runs-on: ubuntu-latest
    needs: [proto]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.x"

      - name: Run tests
        run: cargo test --all-features

  rust-build:
    name: Rust Build
    runs-on: ubuntu-latest
    needs: [rust-lint, rust-test]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.x"

      - name: Build release
        run: cargo build --release

  # ===========================================================================
  # Python
  # ===========================================================================

  python-lint:
    name: Python Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-packages

      - name: Ruff check
        run: uv run ruff check sdks/

      - name: Mypy
        run: uv run mypy sdks/ || echo "Mypy warnings (non-blocking for now)"

  python-test:
    name: Python Test
    runs-on: ubuntu-latest
    needs: [proto]
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --all-packages

      - name: Run tests
        run: uv run pytest sdks/ -v --tb=short

  # ===========================================================================
  # Proto Codegen Check
  # ===========================================================================

  proto-codegen:
    name: Proto Codegen Drift Check
    runs-on: ubuntu-latest
    needs: [proto]
    steps:
      - uses: actions/checkout@v4

      - name: Install buf
        uses: bufbuild/buf-setup-action@v1
        with:
          version: "1.47.2"

      - name: Generate Python protos
        run: |
          mkdir -p sdks/python/src/mlrun/proto
          buf generate --template buf.gen.yaml

      - name: Check for drift
        run: |
          if git diff --exit-code sdks/python/src/mlrun/proto/; then
            echo "Proto codegen is up to date"
          else
            echo "ERROR: Generated proto files have drifted!"
            echo "Run 'make proto' locally and commit the changes."
            exit 1
          fi

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.x"

      - name: Verify Rust proto crate builds
        run: cargo build -p mlrun-proto

  # ===========================================================================
  # UI (placeholder)
  # ===========================================================================

  ui-lint:
    name: UI Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: apps/ui
        run: npm ci

      - name: Lint
        working-directory: apps/ui
        run: npm run lint 2>/dev/null || echo "UI lint not fully configured yet"

  # ===========================================================================
  # Summary
  # ===========================================================================

  ci-complete:
    name: CI Complete
    runs-on: ubuntu-latest
    needs: [proto, rust-lint, rust-test, rust-build, python-lint, python-test, proto-codegen, ui-lint]
    steps:
      - name: All checks passed
        run: echo "All CI checks passed!"
